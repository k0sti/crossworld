# Project Structure

This document describes the organization of the Crossworld project repository.

## Directory Layout

```
crossworld/
├── crates/              # Rust crates
│   ├── world/          # Main world simulation + WASM bindings
│   ├── cube/           # Voxel octree engine (WASM)
│   ├── physics/        # Rapier3D integration (WASM)
│   ├── renderer/       # CPU raytracer (native, experimental)
│   ├── server/         # Game server (WebTransport multiplayer)
│   ├── test-client/    # Server test client
│   ├── assets/         # Asset management tools
│   └── worldtool/      # CLI tool (Nostr, MoQ relay)
├── packages/
│   ├── app/            # Main React application
│   ├── common/         # Shared UI components
│   ├── editor/         # Voxel model editor (future)
│   ├── wasm-world/     # Generated from crates/world
│   ├── wasm-cube/      # Generated from crates/cube
│   └── wasm-physics/   # Generated from crates/physics
├── doc/                # Project documentation
├── openspec/           # OpenSpec system (change proposals)
├── assets/             # Static assets (models, textures, worlds)
└── justfile            # Task automation
```

## Rust Crates (crates/)

### Core Engine Crates

**world/** - Main WASM module:
- World state management
- Avatar system
- WASM bindings for TypeScript
- Integration of other crates

**cube/** - Voxel engine:
- Octree data structure
- CSM (Cube Script Model) format parser/serializer
- Mesh generation with face culling
- Raycasting for voxel selection
- MagicaVoxel (.vox) loader

**physics/** - Physics simulation:
- Rapier3D integration
- Character controllers for avatars
- Voxel collision mesh generation
- Raycasting for ground detection

**renderer/** - CPU raytracer (experimental):
- Software raytracing (not in production use)
- GPU tracer stub (future)
- Reference implementation

**assets/** - Asset management:
- Asset loading and caching
- Future: Asset bundling system

### Tool Crates

**worldtool/** - CLI tool:
- Nostr live event management
- MoQ relay server setup
- World configuration
- Not compiled to WASM (native binary only)

## TypeScript Packages (packages/)

### Application Packages

**app/** - Main React application:
```
app/
├── src/
│   ├── components/     # UI components
│   ├── renderer/       # Three.js rendering
│   │   ├── scene.ts           # Scene management
│   │   ├── avatar.ts          # GLB avatar rendering
│   │   ├── voxel-avatar.ts    # Voxel avatar rendering
│   │   └── base-avatar.ts     # Shared avatar logic
│   ├── services/       # Business logic
│   │   ├── avatar-state.ts    # Nostr avatar state
│   │   └── physics-bridge.ts  # WASM physics interface
│   ├── voice/          # MoQ voice chat
│   │   ├── moq-connection.ts  # Connection management
│   │   ├── publisher.ts       # Audio publishing
│   │   ├── subscriber.ts      # Audio subscription
│   │   └── voice-manager.ts   # Voice coordination
│   ├── utils/          # Utilities
│   │   ├── csmSaver.ts        # CSM save/load
│   │   └── voxLoader.ts       # VOX file loading
│   └── App.tsx         # Main app component
├── public/             # Static assets
│   └── assets/
│       ├── models/     # Avatar models (.vox, .glb)
│       └── worlds/     # World files (.csm)
└── vite.config.ts      # Vite configuration
```

**common/** - Shared UI components:
- Reusable React components
- Shared utilities
- Common types

**editor/** - Voxel model editor (future):
- Standalone voxel editor
- CSM file editing

### Generated WASM Packages

**DO NOT EDIT**: These are auto-generated by wasm-pack

**wasm-world/** - From crates/world:
- `wasm_world_bg.wasm` - Binary
- `wasm_world.js` - JS bindings
- `wasm_world.d.ts` - TS definitions

**wasm-cube/** - From crates/cube:
- Voxel engine bindings
- CSM format functions
- Mesh generation

**wasm-physics/** - From crates/physics:
- Physics simulation
- Character controller
- Collision detection

## Documentation (doc/)

```
doc/
├── README.md                # Documentation index
├── QUICKSTART.md            # Voice chat quick start
├── nostr.md                 # Nostr events specification
│
├── architecture/            # System design
│   ├── overview.md          # High-level architecture
│   ├── voxel-system.md      # Voxel octree and CSM format
│   ├── physics.md           # Physics system (Rapier3D)
│   ├── raycast.md           # Ray-octree intersection
│   └── rendering.md         # Three.js rendering pipeline
│
├── features/                # Feature documentation
│   ├── avatar-system.md     # Avatar design and physics
│   ├── voice-chat.md        # MoQ voice chat (Media over QUIC)
│   └── nostr-integration.md # Nostr identity and discovery
│
└── reference/               # Technical references
    ├── project-structure.md # Repository organization (this file)
    ├── build-system.md      # Justfile commands and WASM builds
    ├── materials.md         # Voxel material definitions
    └── server.md            # Game server design
│   ├── voice-chat.md        # MoQ voice chat
│   └── nostr-integration.md # Nostr protocol
│
└── reference/               # Technical references
    ├── project-structure.md # This file
    ├── build-system.md      # Build process
    └── materials.md         # Material system
```

## OpenSpec System (openspec/)

```
openspec/
├── project.md              # Project context and tech stack
├── AGENTS.md               # OpenSpec workflow
├── changes/                # Change proposals
│   └── <change-id>/
│       ├── proposal.md     # Change description
│       ├── tasks.md        # Implementation tasks
│       ├── design.md       # Design document (optional)
│       └── specs/          # Spec deltas
└── specs/                  # Main specifications (future)
```

## Assets (assets/)

**Static Assets**:
```
assets/
├── models/
│   ├── vox/                # MagicaVoxel models
│   └── glb/                # GLB/GLTF models
├── worlds/
│   └── default.csm         # Default world
└── textures/               # Texture files (future)
```

## Build Artifacts (Generated)

**Excluded from Git** (`.gitignore`):

**target/** - Rust compilation:
- Debug builds
- Release builds
- WASM outputs (intermediate)

**dist/** - Frontend production builds:
- `packages/app/dist/` - Bundled application

**node_modules/** - JavaScript dependencies:
- Installed via `bun install`

**packages/wasm-*/** - Generated WASM bindings:
- Recreated on each WASM build

## Build Flow

### WASM Compilation

```
crates/world/     ─────┐
crates/cube/      ────┼─> wasm-pack build ──> packages/wasm-*/
crates/physics/   ────┘                         (generated)
```

### Application Build

```
packages/wasm-*/  ────┐
packages/app/src/ ────┼─> bun run build ──> packages/app/dist/
public/assets/    ────┘                      (production bundle)
```

### Complete Development Workflow

```
1. just build-wasm-dev
   ↓
   Compiles Rust crates to WASM (dev mode)
   Generates packages/wasm-*/

2. cd packages/app && bun run dev
   ↓
   Starts Vite dev server
   Imports WASM modules
   Hot reloads on TypeScript changes

3. Browser loads app
   ↓
   Initializes WASM modules
   Starts game
```

## Package Dependencies

### Workspace Structure

**Root** `package.json`:
```json
{
  "workspaces": ["packages/*"],
  "dependencies": {
    // Shared dependencies
  }
}
```

**App** `packages/app/package.json`:
```json
{
  "dependencies": {
    "wasm-world": "workspace:*",
    "wasm-cube": "workspace:*",
    "wasm-physics": "workspace:*",
    "three": "^0.170.0",
    // ... other deps
  }
}
```

## Cargo Workspace

**Root** `Cargo.toml`:
```toml
[workspace]
members = [
  "crates/world",
  "crates/cube",
  "crates/physics",
  "crates/renderer",
  "crates/assets",
  "crates/worldtool"
]
```

**Shared Dependencies** (via workspace):
- Common crate versions
- Shared dependency resolution
- Parallel builds

## Related Documentation

- [build-system.md](build-system.md) - Build process details
- [overview.md](../architecture/overview.md) - System architecture
- `justfile` - Task automation source
- `Cargo.toml` - Rust workspace configuration
- `package.json` - JavaScript workspace configuration
